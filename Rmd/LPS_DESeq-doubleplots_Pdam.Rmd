---
title: "LPS_DESeq-doubleplots_Pdam"
author: "Mike Connelly"
date: "11/13/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/computing/projects/EAPSI_Pocillopora_LPS")
library(DESeq2)
library(tidyverse)
library(ggrepel)
library(patchwork)
stringsAsFactors = FALSE
```
```{r}
theme_set(theme_bw())
DEGcolors <- c("dark grey", "blue", "red")
```
```{r}
resultsNames(dds_LPS_int)
```
##Results contrasts between individual treatments and control samples
```{r}
round_df <- function(df, digits) {
  nums <- vapply(df, is.numeric, FUN.VALUE = logical(1))

  df[,nums] <- round(df[,nums], digits = digits)

  (df)
}
```
```{r}
alpha <- -log10(0.05)
```
## Assemble data frame with complete log-fold changes between treatment contrasts
```{r}
doubledf <- data.frame(cbind(res_LPS_int$log2FoldChange, -log10(res_LPS_int$padj),
                             res_HW1_LPS$log2FoldChange, -log10(res_HW1_LPS$padj),
                             res_HW2_LPS$log2FoldChange, -log10(res_HW2_LPS$padj),
                             res_WT1_LPS$log2FoldChange, -log10(res_WT1_LPS$padj),
                             res_WT2_LPS$log2FoldChange, -log10(res_WT2_LPS$padj)))
###
colnames(doubledf) <- c("LFC_LPS", "padj_LPS",
                        "LFC_HW1", "padj_HW1",
                        "LFC_HW2", "padj_HW2",
                        "LFC_WT1", "padj_WT1",
                        "LFC_WT2", "padj_WT2")
doubledf <- round_df(doubledf, digits = 2)
doubledf$ID <- rownames(res_LPS)
doubledf <- doubledf[,c(11, 1:10)] 
doubledf$GeneInfo <- res_LPS$GeneInfo
doubledf$KO_terms <- res_LPS$KO_terms
doubledf$Pfam_domains <- res_LPS$Pfam_domains

# Add DEG up/down columns for single treatments
doubledf$DEG_LPS <- ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS > 0, "Upregulated", 
                           ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS < 0, "Downregulated", "NA"))
doubledf$DEG_LPS <- factor(doubledf$DEG_LPS, levels = c("Upregulated", "Downregulated", "NA"), ordered = TRUE)

doubledf$DEG_HW1 <- ifelse(doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 > 0, "Upregulated", 
                            ifelse(doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 < 0, "Downregulated", "NA"))
doubledf$DEG_HW1 <- factor(doubledf$DEG_HW1, levels = c("Upregulated", "Downregulated", "NA"), ordered = TRUE)

doubledf$DEG_HW2 <- ifelse(doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 > 0, "Upregulated", 
                            ifelse(doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 < 0, "Downregulated", "NA"))
doubledf$DEG_HW2 <- factor(doubledf$DEG_HW2, levels = c("Upregulated", "Downregulated", "NA"), ordered = TRUE)
  
doubledf$DEG_WT1 <- ifelse(doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 > 0, "Upregulated", 
                                ifelse(doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 < 0, "Downregulated", "NA"))
doubledf$DEG_WT1 <- factor(doubledf$DEG_WT1, levels = c("Upregulated", "Downregulated", "NA"), ordered = TRUE)

doubledf$DEG_WT2 <-  ifelse(doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 > 0, "Upregulated", 
                                    ifelse(doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 < 0, "Downregulated", "NA"))
doubledf$DEG_WT2 <- factor(doubledf$DEG_WT2, levels = c("Upregulated", "Downregulated", "NA"), ordered = TRUE)

doubledf <- doubledf[,c(1,12:14,2:3,15,4:5,16,6:7,17,8:9,18,10:11,19)]

# Add DEG threshold columns for two treatment consensus DEGs
doubledf$cDEG_LPS.HW1 <- ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS > 1 & 
                            doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 > 1, "UP_UP",
                            ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS > 1 & 
                            doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 < -1, "UP_DN",
                            ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS < -1 & 
                            doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 > 1, "DN_UP",
                            ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS < -1 & 
                            doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 < -1, "DN_DN", "AA"))))

doubledf$cDEG_LPS.HW2 <- ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS > 1 & 
                            doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 > 1, "UP_UP",
                            ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS > 1 & 
                            doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 < -1, "UP_DN",
                            ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS < -1 & 
                            doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 > 1, "DN_UP",
                            ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS < -1 & 
                            doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 < -1, "DN_DN", "AA"))))

doubledf$cDEG_LPS.WT1 <- ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS > 1 & 
                            doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 > 1, "UP_UP",
                            ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS > 1 & 
                            doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 < -1, "UP_DN",
                            ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS < -1 & 
                            doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 > 1, "DN_UP",
                            ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS < -1 & 
                            doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 < -1, "DN_DN", "AA"))))

doubledf$cDEG_LPS.WT2 <- ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS > 1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 > 1, "UP_UP",
                            ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS > 1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 < -1, "UP_DN",
                            ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS < -1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 > 1, "DN_UP",
                            ifelse(doubledf$padj_LPS > 2 & doubledf$LFC_LPS < -1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 < -1, "DN_DN", "AA"))))

doubledf$cDEG_HW1.HW2 <- ifelse(doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 > 1 & 
                            doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 > 1, "UP_UP",
                            ifelse(doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 > 1 & 
                            doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 < -1, "UP_DN",
                            ifelse(doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 < -1 & 
                            doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 > 1, "DN_UP",
                            ifelse(doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 < -1 & 
                            doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 < -1, "DN_DN", "AA"))))

doubledf$cDEG_HW1.WT1 <- ifelse(doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 > 1 & 
                            doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 > 1, "UP_UP",
                            ifelse(doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 > 1 & 
                            doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 < -1, "UP_DN",
                            ifelse(doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 < -1 & 
                            doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 > 1, "DN_UP",
                            ifelse(doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 < -1 & 
                            doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 < -1, "DN_DN", "AA"))))

doubledf$cDEG_HW1.WT2 <- ifelse(doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 > 1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 > 1, "UP_UP",
                            ifelse(doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 > 1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 < -1, "UP_DN",
                            ifelse(doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 < -1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 > 1, "DN_UP",
                            ifelse(doubledf$padj_HW1 > 2 & doubledf$LFC_HW1 < -1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 < -1, "DN_DN", "AA"))))

doubledf$cDEG_HW2.WT1 <- ifelse(doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 > 1 & 
                            doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 > 1, "UP_UP",
                            ifelse(doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 > 1 & 
                            doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 < -1, "UP_DN",
                            ifelse(doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 < -1 & 
                            doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 > 1, "DN_UP",
                            ifelse(doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 < -1 & 
                            doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 < -1, "DN_DN", "AA"))))

doubledf$cDEG_HW2.WT2 <- ifelse(doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 > 1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 > 1, "UP_UP",
                            ifelse(doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 > 1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 < -1, "UP_DN",
                            ifelse(doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 < -1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 > 1, "DN_UP",
                            ifelse(doubledf$padj_HW2 > 2 & doubledf$LFC_HW2 < -1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 < -1, "DN_DN", "AA"))))

doubledf$cDEG_WT1.WT2 <- ifelse(doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 > 1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 > 1, "UP_UP",
                            ifelse(doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 > 1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 < -1, "UP_DN",
                            ifelse(doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 < -1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 > 1, "DN_UP",
                            ifelse(doubledf$padj_WT1 > 2 & doubledf$LFC_WT1 < -1 & 
                            doubledf$padj_WT2 > 2 & doubledf$LFC_WT2 < -1, "DN_DN", "AA"))))

doubledf <- doubledf %>% arrange(desc(padj_LPS))

write.csv(doubledf, file = "./outputs/DESeq-results/tables/all/all_LFC-padj.csv", row.names = FALSE)

doubledf_intersect <- doubledf %>% filter(DEG_HW1!="NA" & DEG_HW2!="NA" & DEG_WT1!="NA" & DEG_WT2!="NA") 
doubledf_union <- doubledf %>% filter(DEG_LPS != "NA" | DEG_HW1!="NA" | DEG_HW2!="NA" | DEG_WT1!="NA" | DEG_WT2!="NA") 

write.csv(doubledf_union, file = "./outputs/DESeq-results/tables/all/union_LFC-padj.csv", row.names = FALSE)
```

## Doubleplots
### Overall LPS vs. Houwan1
```{r}
dpg_hw1 <- doubledf_union %>% arrange(cDEG_LPS.HW1) %>% ggplot(aes(LFC_LPS, LFC_HW1))
dpg_hw1 <- dpg_hw1 + 
  geom_hline(yintercept = 0, color = "black", size = 0.2) +
  geom_vline(xintercept = 0, color = "black", size = 0.2) +
  geom_abline(intercept = 0, slope = 1, color = "black", size = 0.2, linetype = "dashed") +
  scale_x_continuous(limits = c(-8,8), breaks = seq(-8,8,2)) + 
  scale_y_continuous(limits = c(-8,8), breaks = seq(-8,8,2)) + 
  geom_point(aes(color=cDEG_LPS.HW1), show.legend = FALSE) +
  scale_colour_manual(values = DEGcolors) +
  geom_text_repel(data = doubledf_union[doubledf_union$cDEG_LPS.HW1=="UP_UP",], aes(label = doubledf_union$ID[doubledf_union$cDEG_LPS.HW1=="UP_UP"]), size = 1.5, box.padding = unit(0.25, "lines")) +
  geom_text_repel(data = doubledf_union[doubledf_union$cDEG_LPS.HW1=="DN_DN",], aes(label = doubledf_union$ID[doubledf_union$cDEG_LPS.HW1=="DN_DN"]), size = 1.5, box.padding = unit(0.25, "lines"))
ggsave(dpg_hw1, filename = "./outputs/DESeq-results/figures/doubleplots/double_LPS_HW1.png", device = "png", height = 3, width = 3)
```
### Overall LPS vs. Houwan2
```{r}
dpg_hw2 <- doubledf_union %>% arrange(cDEG_LPS.HW2) %>% ggplot(aes(LFC_LPS, LFC_HW2))
dpg_hw2 <- dpg_hw2 + 
  geom_hline(yintercept = 0, color = "black", size = 0.2) +
  geom_vline(xintercept = 0, color = "black", size = 0.2) +
  geom_abline(intercept = 0, slope = 1, color = "black", size = 0.2, linetype = "dashed") +
  scale_x_continuous(limits = c(-8,8), breaks = seq(-8,8,2)) + 
  scale_y_continuous(limits = c(-8,8), breaks = seq(-8,8,2)) + 
  geom_point(aes(color=cDEG_LPS.HW2), show.legend = FALSE) +
  scale_colour_manual(values = DEGcolors) +
  geom_text_repel(data = doubledf_union[doubledf_union$cDEG_LPS.HW2=="UP_UP",], aes(label = doubledf_union$ID[doubledf_union$cDEG_LPS.HW2=="UP_UP"]), size = 1.5, box.padding = unit(0.25, "lines")) +
  geom_text_repel(data = doubledf_union[doubledf_union$cDEG_LPS.HW2=="DN_DN",], aes(label = doubledf_union$ID[doubledf_union$cDEG_LPS.HW2=="DN_DN"]), size = 1.5, box.padding = unit(0.25, "lines"))
ggsave(dpg_hw2, filename = "./outputs/DESeq-results/figures/doubleplots/double_LPS_HW2.png", device = "png", height = 3, width = 3)
```
### Overall LPS vs. Wanglitung1
```{r}
dpg_wt1 <- doubledf_union %>% arrange(cDEG_LPS.WT1) %>% ggplot(aes(LFC_LPS, LFC_WT1))
dpg_wt1 <- dpg_wt1 + 
  geom_hline(yintercept = 0, color = "black", size = 0.2) +
  geom_vline(xintercept = 0, color = "black", size = 0.2) +
  geom_abline(intercept = 0, slope = 1, color = "black", size = 0.2, linetype = "dashed") +
  scale_x_continuous(limits = c(-8,8), breaks = seq(-8,8,2)) + 
  scale_y_continuous(limits = c(-8,8), breaks = seq(-8,8,2)) + 
  geom_point(aes(color=cDEG_LPS.WT1), show.legend = FALSE) +
  scale_colour_manual(values = DEGcolors) +
  geom_text_repel(data = doubledf_union[doubledf_union$cDEG_LPS.WT1=="UP_UP",], aes(label = doubledf_union$ID[doubledf_union$cDEG_LPS.WT1=="UP_UP"]), size = 1.5, box.padding = unit(0.25, "lines")) +
  geom_text_repel(data = doubledf_union[doubledf_union$cDEG_LPS.WT1=="DN_DN",], aes(label = doubledf_union$ID[doubledf_union$cDEG_LPS.WT1=="DN_DN"]), size = 1.5, box.padding = unit(0.25, "lines"))
ggsave(dpg_wt1, filename = "./outputs/DESeq-results/figures/doubleplots/double_LPS_WT1.png", device = "png", height = 3, width = 3)
```
### Overall LPS vs. Wanglitung2
```{r}
dpg_wt2 <- doubledf_union %>% arrange(cDEG_LPS.WT2) %>% ggplot(aes(LFC_LPS, LFC_WT2))
dpg_wt2 <- dpg_wt2 + 
  geom_hline(yintercept = 0, color = "black", size = 0.2) +
  geom_vline(xintercept = 0, color = "black", size = 0.2) +
  geom_abline(intercept = 0, slope = 1, color = "black", size = 0.2, linetype = "dashed") +
  scale_x_continuous(limits = c(-8,8), breaks = seq(-8,8,2)) + 
  scale_y_continuous(limits = c(-8,8), breaks = seq(-8,8,2)) + 
  geom_point(aes(color=cDEG_LPS.WT2), show.legend = FALSE) +
  scale_colour_manual(values = DEGcolors) +
  geom_text_repel(data = doubledf_union[doubledf_union$cDEG_LPS.WT2=="UP_UP",], aes(label = doubledf_union$ID[doubledf_union$cDEG_LPS.WT2=="UP_UP"]), size = 1.5, box.padding = unit(0.25, "lines")) +
  geom_text_repel(data = doubledf_union[doubledf_union$cDEG_LPS.WT2=="DN_DN",], aes(label = doubledf_union$ID[doubledf_union$cDEG_LPS.WT2=="DN_DN"]), size = 1.5, box.padding = unit(0.25, "lines"))
ggsave(dpg_wt2, filename = "./outputs/DESeq-results/figures/doubleplots/double_LPS_WT2.png", device = "png", height = 3, width = 3)
```
```{r, warning=FALSE}
dpg_hw1 | dpg_hw2 | dpg_wt1 | dpg_wt2
ggsave(filename = "./outputs/DESeq-results/figures/doubleplots/doubles_LPS.png", device = "png", height = 3, width = 12)
```

## Search for genes that respond similarly across genotypes, regardless of significance
```{r}
### genes that are upregulated (LFC > 0) and significantly differentially expressed (padj < 0.05) in at least one genotype or the overall treatment
sims_up <- doubledf %>%
  filter(LFC_LPS > 0 & LFC_HW1 > 0 & LFC_HW2 > 0 & LFC_WT1 > 0 & LFC_WT2 > 0) %>%
  filter(padj_LPS > alpha | padj_HW1 > alpha | padj_HW2 > alpha | padj_WT1 > alpha | padj_WT2 > alpha) %>%
  arrange(desc(padj_LPS)) 
write.csv(sims_up, file = "./outputs/DESeq-results/tables/all/sims_up.csv", row.names = FALSE)
length(sims_up$ID)
```
```{r}
### genes that are upregulated (LFC < 0) and significantly differentially expressed (padj < 0.05) in at least one genotype or the overall treatment
sims_dn <- doubledf %>%
  filter(LFC_LPS < 0 & LFC_HW1 < 0 & LFC_HW2 < 0 & LFC_WT1 < 0 & LFC_WT2 < 0) %>%
  filter(padj_LPS > alpha | padj_HW1 > alpha | padj_HW2 > alpha | padj_WT1 > alpha | padj_WT2 > alpha) %>%
  arrange(desc(padj_LPS)) 
write.csv(sims_dn, file = "./outputs/DESeq-results/tables/all/sims_dn.csv", row.names = FALSE)
length(sims_dn$ID)
```

## Search for genes with interaction effects
```{r}
res_int_HW2 <- as.data.frame(res_LPS_int_HW2) %>% filter(padj < 0.05)
res_int_WT1 <- as.data.frame(res_LPS_int_WT1) %>% filter(padj < 0.05)
res_int_WT2 <- as.data.frame(res_LPS_int_WT2) %>% filter(padj < 0.05)
###
intergenes_HW2 <- res_int_HW2$ID
intergenes_WT1 <- res_int_WT1$ID
intergenes_WT2 <- res_int_WT2$ID
intergenes_WT<- union(res_int_WT1$ID, res_int_WT2$ID)
intergenes <- union(intergenes_WT,  res_int_HW2$ID)
length(intergenes)
```



